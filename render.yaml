# CompliancePro360 render.yaml Blueprint

envGroups:
  # 1. Non-secret config shared by api and worker
  - name: compliance-pro-config
    envVars:
      - key: APP_ENV
        value: production
      - key: APP_NAME
        value: CompliancePro360
      - key: APP_VERSION
        value: 2.0.0
      - key: API_PORT
        value: 8000
      - key: FRONTEND_PORT
        value: 5000
      - key: HTTP_PORT
        value: 80
      - key: HTTPS_PORT
        value: 443
      - key: FLOWER_PORT
        value: 5555
      - key: JWT_ALGORITHM
        value: HS256
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: 30
      - key: REFRESH_TOKEN_EXPIRE_DAYS
        value: 7
      - key: EMAIL_FROM_NAME
        value: CompliancePro360
      - key: LOG_LEVEL
        value: INFO
      - key: BACKUP_ENABLED
        value: true
      - key: BACKUP_SCHEDULE
        value: 0 2 * * *
      - key: BACKUP_RETENTION_DAYS
        value: 30
      - key: RATE_LIMIT_ENABLED
        value: true
      - key: CACHE_TTL
        value: 3600
      - key: MAX_UPLOAD_SIZE
        value: 100M
      - key: ENABLE_WHATSAPP_NOTIFICATIONS
        value: true
      - key: ENABLE_AI_PREDICTIONS
        value: true
      - key: ENABLE_WEB_SCRAPING
        value: true
      - key: ENABLE_CLIENT_PORTAL
        value: true

services:
  # 2. Managed PostgreSQL Database
  - type: postgres
    name: compliance-pro-db
    plan: free

  # 3. Managed Redis Instance (for Celery)
  - type: redis
    name: compliance-pro-redis
    plan: free

  # 4. The main FastAPI API
  - type: web
    name: compliance-pro-api
    plan: free
    runtime: docker
    dockerfilePath: ./Dockerfile
    envGroups:
      - name: compliance-pro-config # <-- Uses the config group
      - name: compliance-pro-secrets # <-- Uses the secret group
    envVars:
      - key: DATABASE_URL
        fromService:
          type: postgres
          name: compliance-pro-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: compliance-pro-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: compliance-pro-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: compliance-pro-redis
          property: connectionString

  # 5. The Celery Background Worker
  - type: worker
    name: compliance-pro-worker
    plan: free
    runtime: docker
    dockerfilePath: ./Dockerfile
    # ▼▼▼ THIS IS STILL A GUESS - I NEED YOUR docker-compose.yml ▼▼▼
    dockerCommand: "celery -A app.tasks worker --loglevel=info"
    envGroups:
      - name: compliance-pro-config # <-- Uses the config group
      - name: compliance-pro-secrets # <-- Uses the secret group
    envVars:
      - key: DATABASE_URL
        fromService:
          type: postgres
          name: compliance-pro-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: compliance-pro-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: compliance-pro-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: compliance-pro-redis
          property: connectionString
